{% extends "base.html" %}

{% block content %}
<main class="recommendations-page">
    <div class="container">
        <div class="page-header">
            <h1>{{ _('Popular & Trending Movies') }}</h1>
            <p>{{ _('Discover the most popular and trending movies in our collection') }}</p>
        </div>

        <!-- Trending Heat Map Section -->
        <div class="trending-heat-section">
            <h2>{{ _('Trending Heat Map') }}</h2>
            <p class="section-description">{{ _('Recent activity trends over the last 7 days') }}</p>

            <div class="trending-content">
                <div class="heat-chart-container">
                    <h3 class="chart-title" style="display:none;">{{ _('Daily Interactions') }}</h3>
                    <canvas id="trendingChart" width="400" height="200"></canvas>
                </div>

                <div class="top-trending-films">
                    <h3 class="top-trending-title">{{ _('Top 10 Trending Films (Last 7 Days)') }}</h3>
                    <div class="trending-films-list">
                        {% for item in trending_data %}
                        <div class="trending-film-item">
                            <div class="trending-rank">#{{ loop.index }}</div>
                            <div class="trending-film-info">
                                <h4><a href="{{ url_for('film.film_detail', film_id=item.film.id) }}">{{ item.film.title }}</a></h4>
                                <div class="trending-stats">
                                    <span class="interaction-count">{{ item.interaction_count }} {{ _('interactions') }}</span>
                                    <span class="like-count">{{ item.film.like_count }} {{ _('total likes') }}</span>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <div class="recommendations-section">
            <h2>{{ _('Popular Movies & Trends') }}</h2>
            <p class="recommendation-info">{{ _('Below are popularity-based lists: most liked, highest rated, and recently added films.') }}</p>

            <div class="recommendation-columns" style="display:grid; grid-template-columns: repeat(3, 1fr); gap:1rem;">
                <div class="recommendation-column">
                    <h3 style="text-align:center;">{{ _('Most Liked') }}</h3>
                    <div class="films-grid">
                        {% for film in most_liked %}
                        <div class="film-card recommended">
                            <div class="film-poster">
                                {% if film.poster_url and (film.poster_url.startswith('http') or film.poster_url.startswith('//')) %}
                                    <img src="{{ film.poster_url }}" alt="{{ film.title }} poster">
                                {% elif film.poster_url and static_file_exists('posters/' ~ film.poster_url) %}
                                    <img src="{{ url_for('static', filename='posters/' ~ film.poster_url) }}" alt="{{ film.title }} poster">
                                {% else %}
                                    <div class="no-poster">No poster</div>
                                {% endif %}
                            </div>
                            <div class="film-info">
                                <h4><a href="{{ url_for('film.film_detail', film_id=film.id) }}">{{ film.title }}</a></h4>
                                <div class="recommendation-score"><strong>{{ film.like_count }}</strong> {{ _('likes') }}</div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <div class="recommendation-column">
                    <h3 style="text-align:center;">{{ _('Highest Rated') }}</h3>
                    <div class="films-grid">
                        {% for film in highest_rated %}
                        <div class="film-card recommended">
                            <div class="film-poster">
                                {% if film.poster_url and (film.poster_url.startswith('http') or film.poster_url.startswith('//')) %}
                                    <img src="{{ film.poster_url }}" alt="{{ film.title }} poster">
                                {% elif film.poster_url %}
                                    <img src="{{ url_for('static', filename='posters/' ~ film.poster_url) }}" alt="{{ film.title }} poster">
                                {% else %}
                                    <div class="no-poster">No poster</div>
                                {% endif %}
                            </div>
                            <div class="film-info">
                                <h4><a href="{{ url_for('film.film_detail', film_id=film.id) }}">{{ film.title }}</a></h4>
                                <div class="recommendation-score"><strong>{{ ('%.1f'|format( (film.rating_sum or 0) / (film.rating_count or 1) )) }}</strong> {{ _('avg rating') }}</div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <div class="recommendation-column">
                    <h3 style="text-align:center;">{{ _('Recently Added') }}</h3>
                    <div class="films-grid">
                        {% for film in recent %}
                        <div class="film-card recommended">
                            <div class="film-poster">
                                {% if film.poster_url and (film.poster_url.startswith('http') or film.poster_url.startswith('//')) %}
                                    <img src="{{ film.poster_url }}" alt="{{ film.title }} poster">
                                {% elif film.poster_url %}
                                    <img src="{{ url_for('static', filename='posters/' ~ film.poster_url) }}" alt="{{ film.title }} poster">
                                {% else %}
                                    <div class="no-poster">No poster</div>
                                {% endif %}
                            </div>
                            <div class="film-info">
                                <h4><a href="{{ url_for('film.film_detail', film_id=film.id) }}">{{ film.title }}</a></h4>
                                <div class="recommendation-score"><small>{{ film.created_at.strftime('%Y-%m-%d') if film.created_at }}</small></div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <div class="recommendation-stats">
            <div class="stat-card">
                <h3>{{ recommendation_data.user_interactions_count }}</h3>
                <p>你的评价数</p>
            </div>
            <div class="stat-card">
                <h3>{{ recommendation_data.total_users }}</h3>
                <p>总用户数</p>
            </div>
            <div class="stat-card">
                <h3>{{ recommendation_data.recommendations|length }}</h3>
                <p>推荐电影数</p>
            </div>
        </div>
    </div>
</main>

{% block scripts %}
    <div id="daily-data" style="display:none" data-daily='{{ daily_interactions|tojson|e }}'></div>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Prepare data for the trending chart
    const dailyDataEl = document.getElementById('daily-data');
    const dailyData = dailyDataEl ? JSON.parse(dailyDataEl.dataset.daily || '[]') : [];
    const labels = dailyData.map(item => {
        const date = new Date(item.date);
        return date.toLocaleDateString('{{ "zh-CN" if session.get("language", "en") == "zh" else "en-US" }}', {
            month: 'short',
            day: 'numeric'
        });
    });
    const data = dailyData.map(item => item.count);

    // Create the trending chart
    const ctx = document.getElementById('trendingChart').getContext('2d');
    const isHighContrast = document.documentElement.classList.contains('high-contrast');
    const chartBorder = isHighContrast ? '#ffffff' : '#ff6b6b';
    const chartBg = isHighContrast ? 'rgba(255,255,255,0.15)' : 'rgba(255, 107, 107, 0.1)';
    const tickColor = isHighContrast ? '#ffffff' : '#666666';

    new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: '{{ _("Daily Interactions") }}',
                data: data,
                borderColor: chartBorder,
                backgroundColor: chartBg,
                borderWidth: 3,
                fill: true,
                tension: 0.4,
                pointBackgroundColor: chartBorder,
                pointBorderColor: isHighContrast ? '#000' : '#fff',
                pointBorderWidth: 2,
                pointRadius: 6,
                pointHoverRadius: 8
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: true,
                    position: 'top'
                },
                tooltip: {
                    mode: 'index',
                    intersect: false,
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    titleColor: '#fff',
                    bodyColor: '#fff',
                    callbacks: {
                        title: function(context) {
                            return '{{ _("Date") }}: ' + context[0].label;
                        },
                        label: function(context) {
                            return '{{ _("Interactions") }}: ' + context.parsed.y;
                        }
                    }
                }
            },
            scales: {
                x: {
                    display: true,
                    title: {
                        display: true,
                        text: '{{ _("Date") }}'
                    },
                    grid: {
                        display: false
                    },
                    ticks: {
                        color: tickColor
                    }
                },
                y: {
                    display: true,
                    title: {
                        display: true,
                        text: '{{ _("Number of Interactions") }}'
                    },
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(0, 0, 0, 0.1)'
                    },
                    ticks: {
                        color: tickColor
                    }
                }
            },
            interaction: {
                intersect: false,
                mode: 'index'
            }
        }
    });
});
</script>
{% endblock %}
{% endblock %}
